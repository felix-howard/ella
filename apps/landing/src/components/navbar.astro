---
/**
 * Sticky responsive navbar with logo, nav links, mobile hamburger, and CTA button.
 * Highlights active page via currentPath prop. Includes focus-visible states,
 * mobile focus trap, Escape key support, animated mobile menu, and scroll shadow.
 */
import { navLinks } from "@/config/navigation";

interface Props {
  currentPath?: string;
}

const { currentPath = "/" } = Astro.props;
---

<!-- Backdrop overlay for mobile menu -->
<div
  id="mobile-backdrop"
  class="fixed inset-0 z-40 bg-black/50 opacity-0 pointer-events-none transition-opacity duration-200 md:hidden"
  aria-hidden="true"
></div>

<nav
  id="main-nav"
  class="fixed top-0 z-50 w-full border-b border-gray-100 bg-white/80 backdrop-blur-md transition-shadow duration-200"
  aria-label="Main navigation"
>
  <div class="mx-auto flex max-w-6xl items-center justify-between px-6 py-4">
    <!-- Logo -->
    <a href="/" class="focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-500">
      <img src="/ella-logo.png" alt="ella.tax" class="h-8 object-contain" />
    </a>

    <!-- Desktop nav links -->
    <div class="hidden items-center gap-8 md:flex">
      {navLinks.map((link) => (
        <a
          href={link.href}
          class:list={[
            "text-sm font-medium transition-colors focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-500",
            currentPath === link.href
              ? "text-primary-600"
              : "text-gray-600 hover:text-gray-900",
          ]}
          aria-current={currentPath === link.href ? "page" : undefined}
        >
          {link.label}
        </a>
      ))}
    </div>

    <div class="flex items-center gap-4">
      <!-- CTA button -->
      <a
        href="https://www.facebook.com/andy.hayven"
        target="_blank"
        rel="noopener noreferrer"
        class="hidden rounded-full bg-primary-600 px-5 py-2.5 text-sm font-semibold text-white shadow-sm transition-all hover:bg-primary-700 active:scale-[0.98] focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-500 sm:inline-block"
      >
        Book a Demo
      </a>

      <!-- Mobile hamburger with animated icon -->
      <button
        id="mobile-menu-btn"
        class="flex h-10 w-10 min-h-[44px] min-w-[44px] items-center justify-center rounded-lg text-gray-600 hover:bg-gray-100 active:scale-[0.98] transition-transform focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-500 md:hidden"
        aria-expanded="false"
        aria-controls="mobile-menu"
        aria-label="Toggle navigation menu"
      >
        <div class="relative h-6 w-6">
          <svg
            id="hamburger-icon"
            class="absolute inset-0 h-6 w-6 transition-all duration-200"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
          </svg>
          <svg
            id="close-icon"
            class="absolute inset-0 h-6 w-6 opacity-0 rotate-90 transition-all duration-200"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </div>
      </button>
    </div>
  </div>

  <!-- Mobile slide-down menu with animation -->
  <div
    id="mobile-menu"
    class="absolute left-0 right-0 top-full origin-top scale-y-0 opacity-0 border-t border-gray-100 bg-white px-6 pb-4 transition-all duration-200 ease-out md:hidden"
    aria-hidden="true"
  >
    <div class="flex flex-col gap-1 pt-2">
      {navLinks.map((link) => (
        <a
          href={link.href}
          class:list={[
            "rounded-lg px-4 py-3 text-base font-medium transition-colors border-b border-gray-50 last:border-b-0 active:scale-[0.98] focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-500",
            currentPath === link.href
              ? "bg-primary-50 text-primary-600"
              : "text-gray-600 hover:bg-gray-50 hover:text-gray-900",
          ]}
          aria-current={currentPath === link.href ? "page" : undefined}
        >
          {link.label}
        </a>
      ))}
      <a
        href="https://www.facebook.com/andy.hayven"
        target="_blank"
        rel="noopener noreferrer"
        class="mt-3 w-full rounded-full bg-primary-600 px-5 py-3 text-center text-base font-semibold text-white shadow-sm transition-colors hover:bg-primary-700 active:scale-[0.98] focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-500"
      >
        Book a Demo
      </a>
    </div>
  </div>
</nav>

<script>
  /** Mobile nav: animated toggle, backdrop, scroll shadow, focus trap, scroll lock */
  const btn = document.getElementById("mobile-menu-btn");
  const menu = document.getElementById("mobile-menu");
  const backdrop = document.getElementById("mobile-backdrop");
  const nav = document.getElementById("main-nav");
  const hamburgerIcon = document.getElementById("hamburger-icon");
  const closeIcon = document.getElementById("close-icon");

  const SCROLL_SHADOW_THRESHOLD = 10;
  let isOpen = false;

  /** Get focusable elements within menu */
  function getFocusableElements(): HTMLElement[] {
    if (!menu) return [];
    return Array.from(menu.querySelectorAll<HTMLElement>(
      'a[href], button:not([disabled]), input:not([disabled])'
    ));
  }

  function closeMenu() {
    if (!isOpen) return;
    isOpen = false;

    // Restore body scroll
    document.body.style.overflow = "";

    // Animate menu closed
    menu?.classList.add("scale-y-0", "opacity-0");
    menu?.classList.remove("scale-y-100", "opacity-100");
    menu?.setAttribute("aria-hidden", "true");

    // Animate backdrop out
    backdrop?.classList.add("opacity-0", "pointer-events-none");
    backdrop?.classList.remove("opacity-100", "pointer-events-auto");

    // Animate hamburger icon back
    hamburgerIcon?.classList.remove("opacity-0", "rotate-90");
    closeIcon?.classList.add("opacity-0", "rotate-90");
    closeIcon?.classList.remove("opacity-100", "rotate-0");

    btn?.setAttribute("aria-expanded", "false");
  }

  function openMenu() {
    if (isOpen) return;
    isOpen = true;

    // Lock body scroll
    document.body.style.overflow = "hidden";

    // Animate menu open
    menu?.classList.remove("scale-y-0", "opacity-0");
    menu?.classList.add("scale-y-100", "opacity-100");
    menu?.setAttribute("aria-hidden", "false");

    // Animate backdrop in
    backdrop?.classList.remove("opacity-0", "pointer-events-none");
    backdrop?.classList.add("opacity-100", "pointer-events-auto");

    // Animate close icon in
    hamburgerIcon?.classList.add("opacity-0", "rotate-90");
    closeIcon?.classList.remove("opacity-0", "rotate-90");
    closeIcon?.classList.add("opacity-100", "rotate-0");

    btn?.setAttribute("aria-expanded", "true");

    // Focus first link for keyboard users
    const firstLink = menu?.querySelector("a");
    firstLink?.focus();
  }

  function toggleMenu() {
    isOpen ? closeMenu() : openMenu();
  }

  btn?.addEventListener("click", toggleMenu);

  // Close on backdrop click
  backdrop?.addEventListener("click", closeMenu);

  // Keyboard handling: Escape to close, Tab trap for accessibility (WCAG 2.1)
  document.addEventListener("keydown", (e) => {
    if (!isOpen) return;

    if (e.key === "Escape") {
      closeMenu();
      btn?.focus();
      return;
    }

    // Focus trap: Tab/Shift+Tab cycles within menu + hamburger button
    if (e.key === "Tab") {
      const focusable = getFocusableElements();
      if (focusable.length === 0) return;

      const firstEl = focusable[0];
      const lastEl = focusable[focusable.length - 1];

      if (e.shiftKey) {
        // Shift+Tab: if on first element or hamburger, go to last
        if (document.activeElement === firstEl || document.activeElement === btn) {
          e.preventDefault();
          lastEl.focus();
        }
      } else {
        // Tab: if on last element, go to hamburger button
        if (document.activeElement === lastEl) {
          e.preventDefault();
          btn?.focus();
        }
      }
    }
  });

  // Scroll shadow effect
  function updateScrollShadow() {
    if (window.scrollY > SCROLL_SHADOW_THRESHOLD) {
      nav?.classList.add("shadow-md");
    } else {
      nav?.classList.remove("shadow-md");
    }
  }

  window.addEventListener("scroll", updateScrollShadow, { passive: true });
  updateScrollShadow(); // Initial check

  // Close menu on window resize (if switching to desktop)
  window.addEventListener("resize", () => {
    if (window.innerWidth >= 768 && isOpen) {
      closeMenu();
    }
  }, { passive: true });
</script>
