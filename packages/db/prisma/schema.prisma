datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated"
  binaryTargets = ["native"]
}

// ============================================
// ENUMS
// ============================================

enum TaxCaseStatus {
  INTAKE
  WAITING_DOCS
  IN_PROGRESS
  READY_FOR_ENTRY
  ENTRY_COMPLETE
  REVIEW
  FILED
}

enum TaxType {
  FORM_1040
  FORM_1120S
  FORM_1065
}

enum DocType {
  SSN_CARD
  DRIVER_LICENSE
  PASSPORT
  W2
  FORM_1099_INT
  FORM_1099_DIV
  FORM_1099_NEC
  FORM_1099_MISC
  FORM_1099_K
  FORM_1099_R
  FORM_1099_G
  FORM_1099_SSA
  BANK_STATEMENT
  PROFIT_LOSS_STATEMENT
  BUSINESS_LICENSE
  EIN_LETTER
  FORM_1098
  FORM_1098_T
  RECEIPT
  BIRTH_CERTIFICATE
  DAYCARE_RECEIPT
  OTHER
  UNKNOWN
}

enum RawImageStatus {
  UPLOADED
  PROCESSING
  CLASSIFIED
  LINKED
  BLURRY
  UNCLASSIFIED
}

enum DigitalDocStatus {
  PENDING
  EXTRACTED
  VERIFIED
  PARTIAL
  FAILED
}

enum ChecklistItemStatus {
  MISSING
  HAS_RAW
  HAS_DIGITAL
  VERIFIED
  NOT_REQUIRED
}

enum ActionType {
  VERIFY_DOCS
  AI_FAILED
  BLURRY_DETECTED
  READY_FOR_ENTRY
  REMINDER_DUE
  CLIENT_REPLIED
}

enum ActionPriority {
  URGENT
  HIGH
  NORMAL
  LOW
}

enum MessageChannel {
  SMS
  PORTAL
  SYSTEM
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum StaffRole {
  ADMIN
  STAFF
  CPA
}

enum Language {
  VI
  EN
}

// ============================================
// MODELS
// ============================================

model Staff {
  id        String    @id @default(cuid())
  clerkId   String?   @unique  // Clerk user ID for auth sync
  email     String    @unique
  name      String
  role      StaffRole @default(STAFF)
  avatarUrl String?
  isActive  Boolean   @default(true)

  // Audit fields
  deactivatedAt DateTime?
  lastLoginAt   DateTime?

  actions   Action[]  @relation("AssignedStaff")

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([clerkId])
}

model Client {
  id        String   @id @default(cuid())
  name      String
  phone     String   @unique
  email     String?
  language  Language @default(VI)

  profile   ClientProfile?
  taxCases  TaxCase[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([phone])
  @@index([name])
}

model ClientProfile {
  id        String  @id @default(cuid())
  clientId  String  @unique
  client    Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)

  filingStatus     String?
  hasW2            Boolean @default(false)
  hasBankAccount   Boolean @default(false)
  hasInvestments   Boolean @default(false)
  hasKidsUnder17   Boolean @default(false)
  numKidsUnder17   Int     @default(0)
  paysDaycare      Boolean @default(false)
  hasKids17to24    Boolean @default(false)
  hasSelfEmployment Boolean @default(false)
  hasRentalProperty Boolean @default(false)

  businessName     String?
  ein              String?
  hasEmployees     Boolean @default(false)
  hasContractors   Boolean @default(false)
  has1099K         Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TaxCase {
  id        String        @id @default(cuid())
  clientId  String
  client    Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)

  taxYear   Int
  taxTypes  TaxType[]
  status    TaxCaseStatus @default(INTAKE)

  rawImages       RawImage[]
  digitalDocs     DigitalDoc[]
  checklistItems  ChecklistItem[]
  conversation    Conversation?
  magicLinks      MagicLink[]
  actions         Action[]
  imageGroups     ImageGroup[]

  lastContactAt    DateTime?
  entryCompletedAt DateTime?
  filedAt          DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clientId, taxYear])
  @@index([status])
  @@index([taxYear])
  @@index([status, taxYear])    // H1: Composite index for filtering by status and year
  @@index([clientId, status])   // H1: Composite index for client's cases by status
}

model RawImage {
  id        String         @id @default(cuid())
  caseId    String
  taxCase   TaxCase        @relation(fields: [caseId], references: [id], onDelete: Cascade)

  r2Key     String         @unique
  r2Url     String?
  filename  String
  mimeType  String
  fileSize  Int

  status          RawImageStatus @default(UPLOADED)
  classifiedType  DocType?
  aiConfidence    Float?
  blurScore       Float?

  // Duplicate detection fields
  imageHash       String?        // Perceptual hash (pHash) for duplicate detection
  imageGroupId    String?
  imageGroup      ImageGroup?    @relation(fields: [imageGroupId], references: [id])

  // Re-upload request tracking
  reuploadRequested   Boolean   @default(false)
  reuploadRequestedAt DateTime?
  reuploadReason      String?
  reuploadFields      Json?     // ["ssn", "wages"] - specific unreadable fields

  checklistItemId String?
  checklistItem   ChecklistItem? @relation(fields: [checklistItemId], references: [id])
  digitalDoc      DigitalDoc?

  uploadedVia    MessageChannel @default(PORTAL)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([caseId])
  @@index([status])
  @@index([imageGroupId])
  @@index([caseId, classifiedType])  // For duplicate detection queries
  @@index([reuploadRequested])
  @@index([caseId, reuploadRequested])
}

// Groups duplicate images of the same physical document
model ImageGroup {
  id          String     @id @default(cuid())
  caseId      String
  taxCase     TaxCase    @relation(fields: [caseId], references: [id], onDelete: Cascade)

  docType     DocType
  bestImageId String?    // Selected best image from group

  images      RawImage[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([caseId])
  @@index([caseId, docType])
}

model DigitalDoc {
  id          String           @id @default(cuid())
  caseId      String
  taxCase     TaxCase          @relation(fields: [caseId], references: [id], onDelete: Cascade)
  rawImageId  String           @unique
  rawImage    RawImage         @relation(fields: [rawImageId], references: [id], onDelete: Cascade)

  docType     DocType
  status      DigitalDocStatus @default(PENDING)

  extractedData Json
  aiConfidence  Float?

  verifiedAt    DateTime?
  verifiedById  String?

  // Field-level verification tracking
  fieldVerifications Json?  // {"ssn": "verified", "wages": "edited", "address": "unreadable"}

  // Copy tracking for data entry
  copiedFields      Json?       // {"ssn": true, "wages": false}
  entryCompleted    Boolean     @default(false)
  entryCompletedAt  DateTime?

  checklistItemId String?
  checklistItem   ChecklistItem? @relation(fields: [checklistItemId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([caseId])
  @@index([docType])
  @@index([status])
  @@index([entryCompleted])
  @@index([caseId, entryCompleted])
}

model ChecklistTemplate {
  id          String   @id @default(cuid())
  taxType     TaxType
  docType     DocType

  labelVi     String
  labelEn     String
  descriptionVi String?
  descriptionEn String?

  isRequired  Boolean  @default(true)
  condition   String?
  sortOrder   Int      @default(0)
  category    String

  checklistItems ChecklistItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([taxType, docType])
  @@index([taxType])
}

model ChecklistItem {
  id          String              @id @default(cuid())
  caseId      String
  taxCase     TaxCase             @relation(fields: [caseId], references: [id], onDelete: Cascade)
  templateId  String
  template    ChecklistTemplate   @relation(fields: [templateId], references: [id])

  status      ChecklistItemStatus @default(MISSING)

  expectedCount Int               @default(1)
  receivedCount Int               @default(0)

  rawImages   RawImage[]
  digitalDocs DigitalDoc[]

  notes       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([caseId, templateId])
  @@index([caseId])
  @@index([status])
  @@index([caseId, status])     // H1: Composite index for case's checklist by status
}

model Conversation {
  id        String   @id @default(cuid())
  caseId    String   @unique
  taxCase   TaxCase  @relation(fields: [caseId], references: [id], onDelete: Cascade)

  messages  Message[]

  lastMessageAt DateTime?
  unreadCount   Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([lastMessageAt])      // M2: Index for inbox sorting
}

model Message {
  id             String           @id @default(cuid())
  conversationId String
  conversation   Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  channel        MessageChannel
  direction      MessageDirection
  content        String           @db.VarChar(5000)  // M3: Limit message length for security

  twilioSid      String?          @unique
  twilioStatus   String?

  attachmentUrls String[]

  isSystem       Boolean          @default(false)
  templateUsed   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([conversationId])
  @@index([createdAt])
}

model MagicLink {
  id        String   @id @default(cuid())
  caseId    String
  taxCase   TaxCase  @relation(fields: [caseId], references: [id], onDelete: Cascade)

  token     String   @unique @default(cuid())

  lastUsedAt DateTime?
  usageCount Int      @default(0)

  expiresAt DateTime?
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([token])
  @@index([caseId])
}

model Action {
  id        String         @id @default(cuid())
  caseId    String
  taxCase   TaxCase        @relation(fields: [caseId], references: [id], onDelete: Cascade)

  type      ActionType
  priority  ActionPriority @default(NORMAL)

  assignedToId String?
  assignedTo   Staff?      @relation("AssignedStaff", fields: [assignedToId], references: [id])

  isCompleted   Boolean    @default(false)
  completedAt   DateTime?

  title         String
  description   String?
  metadata      Json?

  scheduledFor  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([caseId])
  @@index([type])
  @@index([priority])
  @@index([isCompleted])
  @@index([assignedToId])
  @@index([isCompleted, priority])      // Composite index for action queue
  @@index([assignedToId, isCompleted])  // Composite index for staff's pending actions
}
