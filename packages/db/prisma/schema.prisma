datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated"
  binaryTargets = ["native"]
}

// ============================================
// ENUMS
// ============================================

enum TaxCaseStatus {
  INTAKE
  WAITING_DOCS
  IN_PROGRESS
  READY_FOR_ENTRY
  ENTRY_COMPLETE
  REVIEW
  FILED
}

enum TaxType {
  FORM_1040
  FORM_1120S
  FORM_1065
}

enum DocType {
  // Personal / Identity
  SSN_CARD
  DRIVER_LICENSE
  PASSPORT
  BIRTH_CERTIFICATE
  ITIN_LETTER
  MARRIAGE_CERTIFICATE
  DIVORCE_DECREE
  GREEN_CARD
  WORK_VISA
  NATURALIZATION_CERTIFICATE
  POWER_OF_ATTORNEY

  // Employment Income
  W2
  W2G                    // Gambling winnings
  PAY_STUB
  EMPLOYMENT_CONTRACT
  STOCK_OPTION_AGREEMENT
  RSU_STATEMENT
  ESPP_STATEMENT

  // 1099 Series - Various Income
  FORM_1099_INT          // Bank interest
  FORM_1099_DIV          // Dividends
  FORM_1099_NEC          // Non-employee compensation
  FORM_1099_MISC         // Miscellaneous income
  FORM_1099_K            // Payment card transactions
  FORM_1099_R            // Retirement distributions
  FORM_1099_G            // Government payments (unemployment, state refund)
  FORM_1099_SSA          // Social Security
  FORM_1099_B            // Brokerage/stock sales
  FORM_1099_S            // Real estate sales
  FORM_1099_C            // Cancellation of debt
  FORM_1099_SA           // HSA distributions
  FORM_1099_Q            // 529 distributions
  FORM_1099_A            // Acquisition or Abandonment
  FORM_1099_CAP          // Corp Control Changes
  FORM_1099_H            // Health Coverage Tax Credit
  FORM_1099_LS           // Life Insurance Sale
  FORM_1099_LTC          // Long-Term Care Benefits
  FORM_1099_OID          // Original Issue Discount
  FORM_1099_PATR         // Patronage Dividends
  FORM_1099_QA           // ABLE Account Distributions
  FORM_1099_SB           // Seller's Investment in Life Insurance
  RRB_1099               // Railroad Retirement
  RRB_1099_R             // Railroad Retirement Tier 2

  // K-1 Forms (Pass-through income)
  SCHEDULE_K1            // Generic K-1
  SCHEDULE_K1_1065       // Partnership K-1
  SCHEDULE_K1_1120S      // S-Corp K-1
  SCHEDULE_K1_1041       // Trust/Estate K-1

  // Health Insurance
  FORM_1095_A            // Marketplace coverage
  FORM_1095_B            // Health coverage
  FORM_1095_C            // Employer health coverage
  FORM_5498_SA           // HSA contributions

  // Education
  FORM_1098_T            // Tuition statement
  FORM_1098_E            // Student loan interest

  // Deductions / Credits
  FORM_1098              // Mortgage interest
  FORM_8332              // Release of claim to exemption

  // Business Documents
  BANK_STATEMENT
  PROFIT_LOSS_STATEMENT
  BALANCE_SHEET
  BUSINESS_LICENSE
  EIN_LETTER
  ARTICLES_OF_INCORPORATION
  OPERATING_AGREEMENT
  PAYROLL_REPORT         // 941, W-3, etc.
  DEPRECIATION_SCHEDULE
  VEHICLE_MILEAGE_LOG
  PARTNERSHIP_AGREEMENT
  SHAREHOLDER_AGREEMENT
  BUSINESS_INVOICE
  ACCOUNTS_RECEIVABLE
  ACCOUNTS_PAYABLE
  INVENTORY_REPORT
  SALES_TAX_REPORT

  // Receipts & Supporting Docs
  RECEIPT                // Generic receipt
  DAYCARE_RECEIPT
  CHARITY_RECEIPT
  MEDICAL_RECEIPT
  PROPERTY_TAX_STATEMENT
  ESTIMATED_TAX_PAYMENT
  RENT_RECEIPT

  // Prior Year / IRS
  PRIOR_YEAR_RETURN
  IRS_NOTICE

  // Crypto
  CRYPTO_STATEMENT
  CRYPTO_TAX_REPORT
  CRYPTO_TRANSACTION_HISTORY
  STAKING_REWARDS

  // Foreign
  FOREIGN_BANK_STATEMENT
  FOREIGN_TAX_STATEMENT
  FBAR_SUPPORT_DOCS          // FBAR supporting documents
  FORM_8938                  // FATCA foreign financial assets

  // Real Estate / Home Sale
  CLOSING_DISCLOSURE         // HUD closing statement
  LEASE_AGREEMENT            // Rental lease contracts
  HUD_1
  PROPERTY_DEED
  HOME_APPRAISAL
  PMI_STATEMENT

  // Credits / Energy
  EV_PURCHASE_AGREEMENT      // Electric vehicle purchase docs
  ENERGY_CREDIT_INVOICE      // Solar, insulation, etc.

  // Additional Business Docs
  FORM_W9_ISSUED             // W-9s collected from contractors
  MORTGAGE_POINTS_STATEMENT  // Points paid on mortgage

  // Prior Year Extension
  EXTENSION_PAYMENT_PROOF    // Form 4868 / payment confirmation

  // Tax Returns
  FORM_1040              // U.S. Individual Income Tax Return
  FORM_1040_SR           // Tax Return for Seniors
  FORM_1040_NR           // Nonresident Alien Income Tax Return
  FORM_1040_X            // Amended U.S. Individual Income Tax Return
  STATE_TAX_RETURN       // State income tax return (CA 540, etc.)
  FOREIGN_TAX_RETURN     // Foreign country tax return
  TAX_RETURN_TRANSCRIPT  // IRS tax return transcript

  // Form 1040 Schedules
  SCHEDULE_C             // Profit or Loss From Business (Sole Proprietorship)
  SCHEDULE_SE            // Self-Employment Tax
  SCHEDULE_1             // Additional Income and Adjustments to Income
  SCHEDULE_D             // Capital Gains and Losses
  SCHEDULE_E             // Supplemental Income and Loss (Rental, Royalties, etc.)
  SCHEDULE_2             // Additional Taxes
  SCHEDULE_3             // Additional Credits and Payments
  SCHEDULE_A             // Itemized Deductions
  SCHEDULE_B             // Interest and Dividends
  SCHEDULE_EIC           // Earned Income Credit
  SCHEDULE_F             // Farm Income
  SCHEDULE_H             // Household Employment
  SCHEDULE_J             // Income Averaging
  SCHEDULE_R             // Credit for Elderly/Disabled
  SCHEDULE_8812          // Additional Child Tax Credit

  // Critical IRS Forms
  FORM_2210              // Underpayment Penalty
  FORM_2441              // Child Care Expenses
  FORM_2555              // Foreign Earned Income
  FORM_3903              // Moving Expenses
  FORM_4562              // Depreciation & Amortization
  FORM_4684              // Casualties and Thefts
  FORM_4797              // Sales of Business Property
  FORM_4868              // Extension to File
  FORM_5329              // Additional Tax on Qualified Plans
  FORM_5695              // Residential Energy Credits
  FORM_6251              // Alternative Minimum Tax
  FORM_8283              // Noncash Charitable Contributions
  FORM_8379              // Injured Spouse Allocation
  FORM_8582              // Passive Activity Loss
  FORM_8606              // Nondeductible IRAs
  FORM_8829              // Home Office Expenses
  FORM_8863              // Education Credits
  FORM_8880              // Retirement Savings Credit
  FORM_8889              // HSA Deductions
  FORM_8936              // EV Credit
  FORM_8949              // Sales of Capital Assets
  FORM_8959              // Additional Medicare Tax
  FORM_8960              // Net Investment Income Tax
  FORM_8962              // Premium Tax Credit
  FORM_8995              // QBI Deduction
  FORM_8995_A            // QBI Deduction (Complex)

  // Investment Documents
  BROKERAGE_STATEMENT
  TRADE_CONFIRMATION
  COST_BASIS_STATEMENT
  MUTUAL_FUND_STATEMENT
  DIVIDEND_REINVESTMENT

  // Retirement Documents
  PENSION_STATEMENT
  IRA_STATEMENT
  STATEMENT_401K
  ROTH_IRA_STATEMENT
  RMD_STATEMENT

  // Healthcare Documents
  MEDICAL_BILL
  INSURANCE_EOB
  HSA_STATEMENT
  FSA_STATEMENT

  // Insurance Documents
  AUTO_INSURANCE
  HOME_INSURANCE
  LIFE_INSURANCE_STATEMENT
  DISABILITY_INSURANCE

  // Legal Documents
  COURT_ORDER
  SETTLEMENT_AGREEMENT
  ALIMONY_AGREEMENT
  CHILD_SUPPORT_ORDER
  BANKRUPTCY_DOCUMENTS

  // Childcare Documents
  DAYCARE_STATEMENT
  DEPENDENT_CARE_FSA
  NANNY_DOCUMENTATION

  // Gambling Documents
  GAMBLING_LOSS_STATEMENT

  // Miscellaneous Documents
  BANK_LETTER
  LOAN_STATEMENT
  MEMBERSHIP_DUES
  PROFESSIONAL_LICENSE

  // Other
  OTHER
  UNKNOWN
}

enum RawImageStatus {
  UPLOADED
  PROCESSING
  CLASSIFIED
  LINKED
  BLURRY
  UNCLASSIFIED
  DUPLICATE
}

enum DigitalDocStatus {
  PENDING
  EXTRACTED
  VERIFIED
  PARTIAL
  FAILED
}

enum ChecklistItemStatus {
  MISSING
  HAS_RAW
  HAS_DIGITAL
  VERIFIED
  NOT_REQUIRED
}

enum ActionType {
  VERIFY_DOCS
  AI_FAILED
  BLURRY_DETECTED
  READY_FOR_ENTRY
  REMINDER_DUE
  CLIENT_REPLIED
}

enum ActionPriority {
  URGENT
  HIGH
  NORMAL
  LOW
}

enum MessageChannel {
  SMS
  PORTAL
  SYSTEM
  CALL    // Voice call recordings
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum StaffRole {
  ADMIN
  STAFF
  CPA
}

enum Language {
  VI
  EN
}

enum FieldType {
  BOOLEAN
  SELECT
  NUMBER
  NUMBER_INPUT
  CURRENCY
  TEXT
}

enum MessageTemplateCategory {
  PORTAL_LINK  // Initial message requesting doc upload (sends client portal link)
  SCHEDULE_C   // Request for Schedule C (business expenses)
  SCHEDULE_E   // Request for Schedule E (rental property)
}

enum EngagementStatus {
  DRAFT      // Engagement created but intake not complete
  ACTIVE     // Intake complete, work in progress
  COMPLETE   // All tax cases filed
  ARCHIVED   // Past year, read-only
}

enum DocCategory {
  IDENTITY    // Giay to tuy than: SSN, DL, PASSPORT
  INCOME      // Thu nhap: W2, all 1099 variants, K-1
  TAX_RETURNS // Khai thue: 1040 family, state returns, transcripts
  EXPENSE     // Chi phi: RECEIPT, INVOICE
  ASSET       // Tai san: property, vehicle docs
  EDUCATION   // Giao duc: 1098-T, 1098-E
  HEALTHCARE  // Y te: 1095-A/B/C
  OTHER       // Khac: unclassified
}

// ============================================
// MODELS
// ============================================

model Staff {
  id        String    @id @default(cuid())
  clerkId   String?   @unique  // Clerk user ID for auth sync
  email     String    @unique
  name      String
  role        StaffRole @default(STAFF)
  avatarUrl   String?
  phoneNumber String?   // E.164 format (+84901234567)
  isActive    Boolean   @default(true)

  // Upload notification preferences
  notifyOnUpload    Boolean @default(true)   // Enable/disable SMS on client uploads

  // Audit fields
  deactivatedAt DateTime?
  lastLoginAt   DateTime?

  actions   Action[]  @relation("AssignedStaff")
  addedChecklistItems   ChecklistItem[] @relation("AddedChecklistItems")
  skippedChecklistItems ChecklistItem[] @relation("SkippedChecklistItems")
  auditLogs AuditLog[]
  language  Language   @default(VI)
  presence  StaffPresence?

  organizationId    String?
  organization      Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  clientAssignments ClientAssignment[]
  documentViews     DocumentView[]
  uploadedDraftReturns DraftReturn[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([clerkId])
  @@index([organizationId])
}

// Staff presence tracking for inbound call routing
model StaffPresence {
  id        String   @id @default(cuid())
  staffId   String   @unique
  staff     Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  isOnline  Boolean  @default(false)
  deviceId  String?  // Twilio device identity: staff_{staffId}
  lastSeen  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isOnline])
}

model Organization {
  id         String   @id @default(cuid())
  clerkOrgId String   @unique
  name       String
  slug       String?  @unique
  logoUrl    String?
  isActive   Boolean  @default(true)

  smsLanguage         Language @default(VI)
  missedCallTextBack  Boolean  @default(false)

  staff      Staff[]
  clients    Client[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([clerkOrgId])
}

model ClientAssignment {
  id           String   @id @default(cuid())
  clientId     String
  client       Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  staffId      String
  staff        Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  assignedById String?

  createdAt    DateTime @default(now())

  @@unique([clientId, staffId])
  @@index([staffId])
  @@index([clientId])
  @@index([assignedById])
}

model Client {
  id        String   @id @default(cuid())
  firstName String
  lastName  String?
  name      String   @default("")  // Computed field for backward compat - will be populated by API
  phone     String   @unique
  email     String?
  language  Language @default(VI)

  // Client overview profile fields
  avatarUrl      String?   // R2 storage URL for profile picture
  notes          String?   @db.Text  // Rich text notes (HTML from Tiptap)
  notesUpdatedAt DateTime? // Track when notes last edited

  profile      ClientProfile?
  engagements  TaxEngagement[]
  taxCases     TaxCase[]

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  assignments    ClientAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([phone])
  @@index([name])
  @@index([organizationId])
}

/// @deprecated Use TaxEngagement for year-specific profile data.
/// Will be removed after all clients migrate to engagement-based queries.
/// Target removal: 2026-Q3 (2 release cycles after migration)
model ClientProfile {
  id        String  @id @default(cuid())
  clientId  String  @unique
  client    Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)

  filingStatus     String?
  hasW2            Boolean @default(false)
  hasBankAccount   Boolean @default(false)
  hasInvestments   Boolean @default(false)
  hasKidsUnder17   Boolean @default(false)
  numKidsUnder17   Int     @default(0)
  paysDaycare      Boolean @default(false)
  hasKids17to24    Boolean @default(false)
  hasSelfEmployment Boolean @default(false)
  hasRentalProperty Boolean @default(false)

  businessName     String?
  ein              String?
  hasEmployees     Boolean @default(false)
  hasContractors   Boolean @default(false)
  has1099K         Boolean @default(false)

  // Dynamic intake answers - flexible JSON storage for intake questionnaire responses
  // Maps questionKey -> value (boolean, number, string) from IntakeQuestion model
  intakeAnswers    Json    @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// TaxEngagement: Year-specific client profile for multi-year support
// Links Client (permanent) -> TaxEngagement (per-year) -> TaxCase (per-form)
model TaxEngagement {
  id        String           @id @default(cuid())
  clientId  String
  client    Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  taxYear   Int
  status    EngagementStatus @default(DRAFT)

  // Profile fields (copied from ClientProfile for year-specific storage)
  filingStatus       String?
  hasW2              Boolean @default(false)
  hasBankAccount     Boolean @default(false)
  hasInvestments     Boolean @default(false)
  hasKidsUnder17     Boolean @default(false)
  numKidsUnder17     Int     @default(0)
  paysDaycare        Boolean @default(false)
  hasKids17to24      Boolean @default(false)
  hasSelfEmployment  Boolean @default(false)
  hasRentalProperty  Boolean @default(false)
  businessName       String?
  ein                String?
  hasEmployees       Boolean @default(false)
  hasContractors     Boolean @default(false)
  has1099K           Boolean @default(false)
  intakeAnswers      Json    @default("{}")

  // Relations
  taxCases  TaxCase[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clientId, taxYear])
  @@index([clientId])
  @@index([taxYear])
  @@index([status])
  @@index([clientId, status])  // Filter client's engagements by status
}

model TaxCase {
  id        String        @id @default(cuid())

  // BACKWARD COMPAT: Keep clientId/taxYear for gradual migration (deprecate in Phase 5+)
  clientId  String
  client    Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Required engagement link (Phase 3: made non-nullable)
  engagementId String
  engagement   TaxEngagement @relation(fields: [engagementId], references: [id], onDelete: Cascade)

  taxYear   Int
  taxTypes  TaxType[]
  status    TaxCaseStatus @default(INTAKE)

  rawImages         RawImage[]
  digitalDocs       DigitalDoc[]
  checklistItems    ChecklistItem[]
  conversation      Conversation?
  magicLinks        MagicLink[]
  actions           Action[]
  imageGroups       ImageGroup[]
  documentGroups    DocumentGroup[]
  scheduleCExpense  ScheduleCExpense?
  scheduleEExpense  ScheduleEExpense?
  draftReturns      DraftReturn[]

  lastContactAt    DateTime?
  entryCompletedAt DateTime?
  filedAt          DateTime?

  // Manual status flags (REVIEW/FILED are manual transitions)
  isInReview     Boolean   @default(false)
  isFiled        Boolean   @default(false)

  // Activity tracking for sorting & stale detection
  lastActivityAt DateTime  @default(now())

  // Batch document grouping job tracking
  // When non-null, indicates a grouping job is in progress
  groupingJobId    String?
  groupingStartedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clientId, taxYear])
  @@index([status])
  @@index([taxYear])
  @@index([status, taxYear])    // H1: Composite index for filtering by status and year
  @@index([clientId, status])   // H1: Composite index for client's cases by status
  @@index([lastActivityAt])
  @@index([isInReview])
  @@index([isFiled])
  @@index([engagementId])
  @@index([engagementId, status])         // Filter engagement's cases by status
  @@index([engagementId, lastActivityAt]) // Sort engagement's cases by activity
  @@index([groupingJobId])                // Query cases with active grouping jobs
}

model RawImage {
  id        String         @id @default(cuid())
  caseId    String
  taxCase   TaxCase        @relation(fields: [caseId], references: [id], onDelete: Cascade)

  r2Key     String         @unique
  r2Url     String?
  filename  String
  mimeType  String
  fileSize  Int

  status          RawImageStatus @default(UPLOADED)
  classifiedType  DocType?
  category        DocCategory?    // AI-assigned document category
  displayName     String?         @db.VarChar(255)  // Sanitized filename for display (naming convention)
  aiConfidence    Float?
  blurScore       Float?

  // Duplicate detection fields
  imageHash       String?        // Perceptual hash (pHash) for duplicate detection
  imageGroupId    String?
  imageGroup      ImageGroup?    @relation(fields: [imageGroupId], references: [id])
  duplicateOfId   String?        // ID of original image this duplicates (for UI badge/link)

  // AI metadata for fallback rename and multi-page detection (Phase 2+3)
  // { fallbackRename: boolean, documentTitle: string, pageInfo: {...}, reasoning: string }
  aiMetadata      Json?

  // Multi-page document grouping (Phase 3)
  documentGroupId   String?
  documentGroup     DocumentGroup?  @relation(fields: [documentGroupId], references: [id])
  pageNumber        Int?            // Page within group (1, 2, 3...)
  totalPages        Int?            // Total pages in group (known or estimated)
  groupConfidence   Float?          // AI confidence in grouping (0-1)

  // Re-upload request tracking
  reuploadRequested   Boolean   @default(false)
  reuploadRequestedAt DateTime?
  reuploadReason      String?
  reuploadFields      Json?     // ["ssn", "wages"] - specific unreadable fields

  checklistItemId String?
  checklistItem   ChecklistItem? @relation(fields: [checklistItemId], references: [id])
  digitalDoc      DigitalDoc?
  documentViews   DocumentView[]

  uploadedVia    MessageChannel @default(PORTAL)

  // Viewer display settings (persisted rotation for correct document orientation)
  rotation       Int            @default(0)  // 0, 90, 180, 270 degrees clockwise

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([caseId])
  @@index([status])
  @@index([category])                 // Filter by document category
  @@index([imageGroupId])
  @@index([caseId, classifiedType])  // For duplicate detection queries
  @@index([reuploadRequested])
  @@index([caseId, reuploadRequested])
  @@index([documentGroupId])          // Multi-page grouping lookup
  @@index([caseId, documentGroupId])  // Find pages in same group
}

// Groups duplicate images of the same physical document
model ImageGroup {
  id          String     @id @default(cuid())
  caseId      String
  taxCase     TaxCase    @relation(fields: [caseId], references: [id], onDelete: Cascade)

  docType     DocType
  bestImageId String?    // Selected best image from group

  images      RawImage[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([caseId])
  @@index([caseId, docType])
}

// Groups multi-page document uploads (Phase 3)
// Tracks related pages uploaded separately (e.g., 3-page form uploaded as 3 images)
model DocumentGroup {
  id              String      @id @default(cuid())
  caseId          String
  case            TaxCase     @relation(fields: [caseId], references: [id], onDelete: Cascade)

  baseName        String      // Base filename without _PartXofY
  documentType    String?     // Identified document type (or from fallback)
  pageCount       Int         @default(1)
  confidence      Float       // AI confidence in grouping

  images          RawImage[]

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([caseId])
  @@index([caseId, createdAt])  // Recent groups in case
}

model DigitalDoc {
  id          String           @id @default(cuid())
  caseId      String
  taxCase     TaxCase          @relation(fields: [caseId], references: [id], onDelete: Cascade)
  rawImageId  String           @unique
  rawImage    RawImage         @relation(fields: [rawImageId], references: [id], onDelete: Cascade)

  docType     DocType
  status      DigitalDocStatus @default(PENDING)

  extractedData Json
  aiConfidence  Float?

  verifiedAt    DateTime?
  verifiedById  String?

  // Field-level verification tracking
  fieldVerifications Json?  // {"ssn": "verified", "wages": "edited", "address": "unreadable"}

  // Copy tracking for data entry
  copiedFields      Json?       // {"ssn": true, "wages": false}
  entryCompleted    Boolean     @default(false)
  entryCompletedAt  DateTime?

  checklistItemId String?
  checklistItem   ChecklistItem? @relation(fields: [checklistItemId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([caseId])
  @@index([docType])
  @@index([status])
  @@index([entryCompleted])
  @@index([caseId, entryCompleted])
}

model ChecklistTemplate {
  id          String   @id @default(cuid())
  taxType     TaxType
  docType     DocType

  labelVi     String
  labelEn     String
  descriptionVi String?
  descriptionEn String?
  hintVi      String?   // Help text shown to clients
  hintEn      String?

  isRequired  Boolean  @default(true)
  condition   String?   // JSON: {"questionKey": value} - only show if profile matches
  sortOrder   Int      @default(0)
  category    String
  expectedCount Int    @default(1)  // How many documents expected (e.g., 12 for bank statements)

  // Optional link to document library for extended metadata
  docTypeLibraryId String?
  docTypeLibrary   DocTypeLibrary? @relation(fields: [docTypeLibraryId], references: [id])

  checklistItems ChecklistItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([taxType, docType])
  @@index([taxType])
  @@index([category])
}

model ChecklistItem {
  id          String              @id @default(cuid())
  caseId      String
  taxCase     TaxCase             @relation(fields: [caseId], references: [id], onDelete: Cascade)
  templateId  String
  template    ChecklistTemplate   @relation(fields: [templateId], references: [id])

  status      ChecklistItemStatus @default(MISSING)

  expectedCount Int               @default(1)
  receivedCount Int               @default(0)

  rawImages   RawImage[]
  digitalDocs DigitalDoc[]

  notes       String?

  // Staff override fields
  isManuallyAdded  Boolean   @default(false)
  addedById        String?
  addedBy          Staff?    @relation("AddedChecklistItems", fields: [addedById], references: [id])
  addedReason      String?
  skippedAt        DateTime?
  skippedById      String?
  skippedBy        Staff?    @relation("SkippedChecklistItems", fields: [skippedById], references: [id])
  skippedReason    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([caseId, templateId])
  @@index([caseId])
  @@index([status])
  @@index([caseId, status])     // H1: Composite index for case's checklist by status
}

model Conversation {
  id        String   @id @default(cuid())
  caseId    String   @unique
  taxCase   TaxCase  @relation(fields: [caseId], references: [id], onDelete: Cascade)

  messages  Message[]

  lastMessageAt DateTime?
  unreadCount   Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([lastMessageAt, createdAt]) // Composite index for inbox sorting with secondary sort
}

model Message {
  id             String           @id @default(cuid())
  conversationId String
  conversation   Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  channel        MessageChannel
  direction      MessageDirection
  content        String           @db.VarChar(5000)  // M3: Limit message length for security

  twilioSid      String?          @unique
  twilioStatus   String?

  attachmentUrls  String[]
  attachmentR2Keys String[]  // Permanent R2 keys for refreshing expired URLs

  isSystem       Boolean          @default(false)
  templateUsed   String?

  // Voice call specific fields (null for non-CALL messages)
  callSid           String?       // Twilio Call SID
  recordingUrl      String?       // Twilio recording URL (.mp3)
  recordingDuration Int?          // Recording duration in seconds
  callStatus        String?       // completed, no-answer, busy, failed, canceled

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([conversationId])
  @@index([createdAt])
  @@index([callSid])
}

model MagicLink {
  id        String   @id @default(cuid())
  caseId    String
  taxCase   TaxCase  @relation(fields: [caseId], references: [id], onDelete: Cascade)

  token     String   @unique @default(cuid())
  type      MagicLinkType @default(PORTAL)  // PORTAL for docs, SCHEDULE_C for expense form

  // Optional reference for DRAFT_RETURN type
  draftReturnId String?
  draftReturn   DraftReturn? @relation(fields: [draftReturnId], references: [id], onDelete: SetNull)

  lastUsedAt DateTime?
  usageCount Int      @default(0)

  expiresAt DateTime?
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([token])
  @@index([caseId])
  @@index([caseId, isActive, createdAt])  // Phase 02: Composite index for request-reupload queries
  @@index([type])  // Filter by link type
  @@index([caseId, type, isActive])  // Phase 02: Composite index for Schedule C queries
  @@index([draftReturnId])  // Draft return lookup
}

model Action {
  id        String         @id @default(cuid())
  caseId    String
  taxCase   TaxCase        @relation(fields: [caseId], references: [id], onDelete: Cascade)

  type      ActionType
  priority  ActionPriority @default(NORMAL)

  assignedToId String?
  assignedTo   Staff?      @relation("AssignedStaff", fields: [assignedToId], references: [id])

  isCompleted   Boolean    @default(false)
  completedAt   DateTime?

  title         String
  description   String?
  metadata      Json?

  scheduledFor  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([caseId])
  @@index([type])
  @@index([priority])
  @@index([isCompleted])
  @@index([assignedToId])
  @@index([isCompleted, priority])      // Composite index for action queue
  @@index([assignedToId, isCompleted])  // Composite index for staff's pending actions
}

// ============================================
// DYNAMIC CHECKLIST CONFIGURATION
// ============================================

// Intake questions - Dynamic questionnaire for client intake
model IntakeQuestion {
  id          String      @id @default(cuid())
  taxTypes    TaxType[]   // Which tax types this question applies to
  questionKey String      @unique  // e.g., "hasW2", "hasRentalProperty"

  labelVi     String
  labelEn     String
  hintVi      String?
  hintEn      String?

  fieldType   FieldType   // BOOLEAN, SELECT, NUMBER, TEXT
  options     String?     // JSON for SELECT type options
  condition   String?     // JSON: show if other answer matches {"questionKey": "value"}
  section     String      // Section grouping: tax_info, income, dependents, business, deductions, foreign
  sortOrder   Int         @default(0)
  isActive    Boolean     @default(true)

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([isActive])
}

// Comprehensive document type library for staff document recognition
model DocTypeLibrary {
  id          String      @id @default(cuid())
  code        String      @unique  // Internal code matching DocType enum or custom

  labelVi     String
  labelEn     String
  descriptionVi String?
  descriptionEn String?

  category    String      // personal, income, deductions, business, health, foreign, other
  aliases     String[]    // Alternative names for AI matching
  keywords    String[]    // Keywords for search/classification

  sortOrder   Int         @default(0)
  isActive    Boolean     @default(true)

  // Link to checklist templates that use this doc type
  checklistTemplates ChecklistTemplate[]

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([category])
  @@index([isActive])
}

// ============================================
// MESSAGE TEMPLATES
// ============================================

// Message templates for quick client communication
model MessageTemplate {
  id          String                  @id @default(cuid())
  category    MessageTemplateCategory
  title       String                  // Short title for list display
  content     String                  @db.VarChar(2000)  // Template content with placeholders
  placeholders String[]               // e.g., ["clientName", "docType"]
  sortOrder   Int                     @default(0)
  isActive    Boolean                 @default(true)

  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  @@index([category])
  @@index([isActive])
}

// ============================================
// AUDIT LOGGING
// ============================================

// Entity types that can be audited
enum AuditEntityType {
  CLIENT
  CLIENT_PROFILE
  TAX_CASE
  TAX_ENGAGEMENT
  ORGANIZATION
}

// Magic link types for different form flows
enum MagicLinkType {
  PORTAL       // Existing document upload
  SCHEDULE_C   // Self-employed expense collection form
  SCHEDULE_E   // Rental property expense collection form
  DRAFT_RETURN // Draft tax return PDF viewing
}

enum ScheduleCStatus {
  DRAFT       // Client editing
  SUBMITTED   // Client submitted, CPA can review
  LOCKED      // CPA locked, no more edits
}

enum ScheduleEStatus {
  DRAFT       // Client editing
  SUBMITTED   // Client submitted, CPA can review
  LOCKED      // CPA locked, no more edits
}

enum DraftReturnStatus {
  ACTIVE      // Current version, link valid
  REVOKED     // Link manually revoked
  EXPIRED     // Link expired
  SUPERSEDED  // Replaced by newer version
}

// Audit log for tracking field-level changes
model AuditLog {
  id          String          @id @default(cuid())
  entityType  AuditEntityType
  entityId    String          // clientId, profileId, or caseId
  field       String          // Field name that was changed
  oldValue    Json?           // Previous value (null for new fields)
  newValue    Json?           // New value (null for deleted fields)
  changedById String?         // Staff who made the change
  changedBy   Staff?          @relation(fields: [changedById], references: [id])
  createdAt   DateTime        @default(now())

  @@index([entityType, entityId])
  @@index([changedById])
  @@index([createdAt])
}

// ============================================
// SCHEDULE C EXPENSE COLLECTION
// ============================================

// Schedule C (Form 1040) expense data for self-employed clients
// Stores income, 20+ IRS Part II expense categories, vehicle info
// One Schedule C per TaxCase (multi-business out of scope)
model ScheduleCExpense {
  id        String          @id @default(cuid())
  taxCaseId String          @unique
  taxCase   TaxCase         @relation(fields: [taxCaseId], references: [id], onDelete: Cascade)

  status    ScheduleCStatus @default(DRAFT)

  // === Business Information ===
  businessName    String?   @db.VarChar(200)  // Principal business or profession
  businessDesc    String?   @db.VarChar(500)  // Business description / product or service

  // === Income Section (Part I) ===
  // All monetary fields use Decimal(12,2) for precision up to $999,999,999.99
  grossReceipts   Decimal?  @db.Decimal(12, 2)  // Line 1: Gross receipts or sales
  returns         Decimal?  @db.Decimal(12, 2)  // Line 2: Returns and allowances
  costOfGoods     Decimal?  @db.Decimal(12, 2)  // Line 4: Cost of goods sold (Part III total)
  otherIncome     Decimal?  @db.Decimal(12, 2)  // Line 6: Other income

  // === Expenses (Part II) - IRS Schedule C Line 8-27 ===
  // Note: carExpense (Line 9) and vehicleMiles are mutually exclusive - use one method only
  advertising             Decimal?  @db.Decimal(12, 2)  // Line 8
  carExpense              Decimal?  @db.Decimal(12, 2)  // Line 9: Actual car/truck expenses (OR use mileage)
  commissions             Decimal?  @db.Decimal(12, 2)  // Line 10
  contractLabor           Decimal?  @db.Decimal(12, 2)  // Line 11
  depletion               Decimal?  @db.Decimal(12, 2)  // Line 12
  depreciation            Decimal?  @db.Decimal(12, 2)  // Line 13: Depreciation and Sec 179
  employeeBenefits        Decimal?  @db.Decimal(12, 2)  // Line 14
  insurance               Decimal?  @db.Decimal(12, 2)  // Line 15: Insurance (other than health)
  interestMortgage        Decimal?  @db.Decimal(12, 2)  // Line 16a
  interestOther           Decimal?  @db.Decimal(12, 2)  // Line 16b
  legalServices           Decimal?  @db.Decimal(12, 2)  // Line 17
  officeExpense           Decimal?  @db.Decimal(12, 2)  // Line 18
  pensionPlans            Decimal?  @db.Decimal(12, 2)  // Line 19
  rentEquipment           Decimal?  @db.Decimal(12, 2)  // Line 20a
  rentProperty            Decimal?  @db.Decimal(12, 2)  // Line 20b
  repairs                 Decimal?  @db.Decimal(12, 2)  // Line 21
  supplies                Decimal?  @db.Decimal(12, 2)  // Line 22
  taxesAndLicenses        Decimal?  @db.Decimal(12, 2)  // Line 23
  travel                  Decimal?  @db.Decimal(12, 2)  // Line 24a
  meals                   Decimal?  @db.Decimal(12, 2)  // Line 24b: Deductible meals (50%)
  utilities               Decimal?  @db.Decimal(12, 2)  // Line 25
  wages                   Decimal?  @db.Decimal(12, 2)  // Line 26
  otherExpenses           Decimal?  @db.Decimal(12, 2)  // Line 27a
  otherExpensesNotes      String?   @db.VarChar(1000)   // Line 27a description

  // === Custom Expenses (dynamic "Other" list) ===
  customExpenses          Json?     @default("[]")  // [{name: string, amount: number}]

  // === Vehicle Information (Part IV) ===
  vehicleMiles            Int?      // Total business miles driven
  vehicleCommuteMiles     Int?      // Commuting miles (not deductible)
  vehicleOtherMiles       Int?      // Other personal miles
  vehicleDateInService    DateTime? // Date vehicle placed in service
  vehicleUsedForCommute   Boolean   @default(false)
  vehicleAnotherAvailable Boolean   @default(false) // Another vehicle for personal use
  vehicleEvidenceWritten  Boolean   @default(false) // Written evidence to support deduction

  // === Version Tracking ===
  // versionHistory JSON structure:
  // [{ version: number, data: {...expense fields}, submittedAt: string, changes: string[] }]
  version         Int     @default(1)
  versionHistory  Json    @default("[]")

  // === Timestamps ===
  submittedAt DateTime?  // When client submitted (status -> SUBMITTED)
  lockedAt    DateTime?  // When CPA locked (status -> LOCKED)
  lockedById  String?    // Staff who locked
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([status])
  @@index([taxCaseId, status])
}

// ============================================
// SCHEDULE E RENTAL PROPERTY EXPENSE COLLECTION
// ============================================

// Schedule E (Form 1040) rental property data for clients with rental income
// Stores up to 3 properties as JSON array with income and expense data
// One ScheduleEExpense per TaxCase (all properties in single record)
model ScheduleEExpense {
  id          String          @id @default(cuid())
  taxCaseId   String          @unique
  taxCase     TaxCase         @relation(fields: [taxCaseId], references: [id], onDelete: Cascade)

  status      ScheduleEStatus @default(DRAFT)

  // === Properties (up to 3) stored as JSON array ===
  // Each property: { id, address, propertyType, monthsRented, fairRentalDays,
  //   personalUseDays, rentsReceived, expenses (7 fields), otherExpenses[], totals }
  properties  Json            @default("[]")

  // === Version Tracking ===
  // versionHistory JSON structure:
  // [{ version: number, properties: [...], submittedAt: string, changes: string[] }]
  version         Int         @default(1)
  versionHistory  Json        @default("[]")

  // === Timestamps ===
  submittedAt DateTime?  // When client submitted (status -> SUBMITTED)
  lockedAt    DateTime?  // When CPA locked (status -> LOCKED)
  lockedById  String?    // Staff who locked

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([status])
  @@index([taxCaseId, status])
  @@index([lockedById])
}

// ============================================
// DRAFT RETURN SHARING
// ============================================

// Draft tax return sharing - CPAs upload PDF for client review via portal
model DraftReturn {
  id            String   @id @default(cuid())
  taxCaseId     String
  taxCase       TaxCase  @relation(fields: [taxCaseId], references: [id], onDelete: Cascade)

  // PDF storage
  r2Key         String   @unique // cases/{caseId}/draft-returns/{timestamp}.pdf
  filename      String   // Original filename for display
  fileSize      Int      // Bytes

  // Versioning
  version       Int      @default(1)

  // Uploader
  uploadedById  String
  uploadedBy    Staff    @relation(fields: [uploadedById], references: [id])

  // Status
  status        DraftReturnStatus @default(ACTIVE)

  // View tracking
  viewCount     Int      @default(0)
  lastViewedAt  DateTime?

  // Magic link for portal access
  magicLinks    MagicLink[]

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([taxCaseId])
  @@index([taxCaseId, status])
  @@index([status])
}

// ============================================
// DOCUMENT VIEW TRACKING
// ============================================

// Tracks which documents each staff member has viewed
// Used for per-CPA "new upload" badge calculations
model DocumentView {
  id         String   @id @default(cuid())
  staffId    String
  staff      Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  rawImageId String
  rawImage   RawImage @relation(fields: [rawImageId], references: [id], onDelete: Cascade)
  viewedAt   DateTime @default(now())

  @@unique([staffId, rawImageId])
  @@index([staffId])
  @@index([rawImageId])
}
